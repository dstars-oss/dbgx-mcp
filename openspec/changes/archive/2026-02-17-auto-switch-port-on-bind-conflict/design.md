## 上下文

当前实现按单一配置端口启动 MCP HTTP 服务；当该端口已被占用时，监听初始化失败，服务不可用，需要用户手动改端口后重试。该问题在并行调试会话与自动化测试中高频出现。

本变更约束：
- 保持现有 JSON-RPC 协议、工具语义与错误语义不变。
- 继续使用现有 C++/WinDbg 扩展实现，不引入第三方依赖。
- 端口选择结果必须在 WinDbg 可见输出中可定位。

## 目标 / 非目标

**目标：**
- 在监听端口冲突（address already in use）时自动尝试后续候选端口，直到成功或达到上限。
- 定义可预测的端口选择规则，避免随机行为导致复现困难。
- 在启动日志中输出冲突重试过程与最终绑定端口，便于客户端连接与排障。
- 保持非端口冲突错误的失败语义清晰且可诊断。

**非目标：**
- 不新增独立的端口发现 RPC 接口。
- 不实现运行时热切换端口（仅覆盖启动阶段）。
- 不在本次变更中引入复杂的动态端口分配策略（如随机扫描整个端口空间）。

## 决策

### 决策 1: 使用“起始端口 + 顺序递增”的确定性回退策略
- 方案：从配置/默认起始端口开始，遇到占用后按固定步长（+1）依次尝试，直到达到最大尝试次数。
- 原因：确定性强、易复现、便于测试断言与运维排障。
- 备选方案：
  - 随机选端口：实现简单，但复现与定位困难。
  - 直接使用端口 0 由系统分配：成功率高，但会弱化可预测性并增加客户端发现成本。

### 决策 2: 仅“端口占用”错误可重试，其它绑定错误快速失败
- 方案：识别地址占用错误并进入下一候选端口；权限不足、地址无效等错误直接终止启动。
- 原因：避免对不可恢复错误进行无效重试，缩短失败反馈路径。
- 备选方案：
  - 对所有绑定错误统一重试：可能掩盖真实配置问题并延长故障时间。

### 决策 3: 将回退链路与最终端口纳入 WinDbg 可见日志
- 方案：记录“初始端口、冲突次数、最终端口或最终失败原因”。
- 原因：端口发生变化后，客户端需要可靠信息完成连接；同时便于故障定位。
- 备选方案：
  - 仅在调试构建输出详细日志：正式使用场景信息不足，不利于排障。

### 决策 4: 对端口尝试上限设定默认值并支持后续配置扩展
- 方案：在当前实现中定义保守默认上限（例如有限次数），并预留与现有配置入口对接。
- 原因：兼顾启动成功率与启动耗时，避免无限重试。
- 备选方案：
  - 无上限重试：可能导致启动挂起，用户体验不可控。

## 风险 / 权衡

- [客户端默认固定端口假设失效] -> 在启动输出中明确最终端口，并在文档中强调端口可能回退。
- [连续冲突导致启动耗时增加] -> 设定最大尝试次数并在失败时快速返回清晰错误。
- [并发竞争造成“刚可用又被占用”] -> 采用“直接 bind 尝试”循环而非先探测后绑定，减少竞态窗口。
- [日志过多影响可读性] -> 对重试日志使用摘要化格式，仅保留关键字段。

## 迁移计划

1. 在 HTTP 服务启动路径接入端口回退循环与错误分类处理。
2. 增加/更新单元测试，覆盖初始成功、冲突回退成功、连续冲突失败三条路径。
3. 更新 README（中英文）中关于端口监听与排障的说明。
4. 手工验收：占用默认端口后启动扩展，确认自动回退与最终端口可见。

回滚策略：若出现不可接受兼容性问题，可回滚为单端口绑定逻辑；该回滚不影响 JSON-RPC 协议层。

## 待决问题

- 默认最大尝试次数最终取值（需要在“成功率”与“启动耗时”间平衡）。
- 是否在后续版本增加机器可读的端口发现入口（本变更暂不包含）。
