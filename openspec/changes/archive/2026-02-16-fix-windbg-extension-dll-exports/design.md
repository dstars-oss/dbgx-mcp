## 上下文

当前扩展 DLL 在用户侧出现 `.load` 失败，问题暴露出“构建成功”与“可被 WinDbg 稳定加载”之间缺少显式契约与自动验证。
现有工程使用 CMake 构建 `dbgx-mcp`，但尚未把导出符号、加载命令写法和常见失败诊断固化为规范化交付物。
本次设计目标是在不引入第三方依赖的前提下，补齐可加载性约束与验证闭环。

## 目标 / 非目标

**目标：**
- 明确 WinDbg 扩展必须导出的入口符号及其稳定命名约束。
- 提供构建后自动化导出检查，尽早发现“产物存在但导出不正确”的问题。
- 补充最小加载验证步骤与文档化诊断指引，降低现场排障成本。
- 保持现有 MCP HTTP 功能行为不变，仅增强加载可靠性与可维护性。

**非目标：**
- 不重构 MCP 路由、HTTP 服务或 `windbg.eval` 业务逻辑。
- 不引入新的第三方测试框架或二进制分析依赖。
- 不覆盖所有 WinDbg 扩展模型，仅聚焦当前 DbgEng 经典扩展入口。

## 决策

### 决策 1：使用显式导出清单保证入口符号稳定

- 采用模块导出清单（如 `.def` 或等效显式导出配置）约束导出符号集合。
- 关键符号至少包含：`DebugExtensionInitialize`、`DebugExtensionUninitialize`、`DebugExtensionCanUnload`（以及项目当前已公开并需兼容的入口）。
- 原因：避免依赖编译器默认导出行为或名称修饰，减少工具链差异导致的加载失败。
- 备选方案：仅依赖 `extern "C"`/`__declspec(dllexport)`。未采用原因：长期维护中更易出现漏导出或链接配置漂移。

### 决策 2：引入构建后导出验证

- 在构建流程中增加导出符号检查步骤，对照契约验证 DLL 导出列表。
- 验证失败时构建或测试应直接失败，阻断回归进入主线。
- 原因：把“可加载性”从手工检查前移为自动门禁。
- 备选方案：仅人工使用 `dumpbin /exports` 检查。未采用原因：无法稳定防回归。

### 决策 3：文档化可复制的加载与诊断流程

- 在 `README.md` 提供可直接复制的 `.load` 命令示例（包含 Windows 路径写法注意事项）。
- 增加最小诊断步骤：路径存在性、导出检查、常见错误码与处理建议。
- 原因：用户最常遇到的问题发生在环境与命令层面，文档是最低成本的可靠性提升手段。
- 备选方案：仅在代码注释说明。未采用原因：用户加载失败时无法先执行代码路径。

## 风险 / 权衡

- [不同构建环境中导出检查工具路径不一致] -> 通过 CMake 配置可覆盖检查工具路径，并提供失败时的手工检查命令。
- [WinDbg 版本对入口符号兼容性存在差异] -> 以微软样例与当前目标版本为基线，保留必要兼容入口并在规格中声明。
- [文档与实现可能漂移] -> 将导出契约与验证步骤纳入任务清单和验收标准，避免仅文档更新。

## 迁移计划

1. 增加导出契约文件并接入 CMake 构建目标。
2. 增加导出检查步骤（构建后或测试阶段）并接入现有 CI/本地验证流程。
3. 更新 `README.md` 中的加载命令与故障排查章节。
4. 运行构建与测试，并执行最小 WinDbg 加载验证。

回滚策略：移除新增导出检查与文档增量，恢复到现有构建方式；不影响 MCP 运行时逻辑。

## 未决问题

- 是否将“最小 WinDbg 加载验证”自动化为脚本，还是暂时保持手工验收步骤。
- 是否在本变更中同时约束 Debug/Release 构建产物的加载差异（如运行库依赖差异）。

