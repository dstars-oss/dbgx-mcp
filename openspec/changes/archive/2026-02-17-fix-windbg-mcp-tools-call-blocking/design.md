## 上下文

当前实现已经具备 WinDbg 可见的 MCP 请求/响应摘要，但主要是单行信息，缺少对同一请求跨阶段关联、阶段边界和耗时的统一表达。实际排障时，常见现象是只看到 `mcp.request` 而看不到后续 `mcp.response`，无法快速判断是路由解析问题、工具执行阻塞，还是响应发送失败。

该变更面向 `windbg-mcp` 调试链路本身的可观测性，不改变 MCP 对外协议、工具输入输出或错误语义。约束是继续保持敏感信息脱敏与摘要截断策略，并避免引入第三方依赖。

## 目标 / 非目标

**目标：**
- 在 WinDbg 输出中建立请求生命周期可读视图，覆盖接收、路由、工具执行、响应返回等关键阶段。
- 为同一请求提供稳定关联键（优先使用 JSON-RPC `id`，缺失时使用本地关联标识），便于串联多条日志。
- 在关键阶段输出排障字段（例如 `rpc_method`、`tool`、`stage`、`outcome`、`duration_ms`、错误摘要）。
- 保持现有行为兼容：HTTP 状态码、JSON-RPC 结果与 `windbg.eval` 语义不变。

**非目标：**
- 不引入新的 MCP 方法或新工具能力。
- 不实现流式 GET 通道或 SSE 协议扩展。
- 不在本次变更中实现命令执行超时中断机制，只提升可观测与定位能力。

## 决策

### 决策 1: 采用“生命周期阶段 + 关联键”的日志模型
- 方案：每个请求至少输出开始与结束阶段，并在必要时补充中间阶段；统一携带关联键。
- 原因：当前日志虽然有请求和响应摘要，但缺乏上下文绑定，跨条目排查成本高。
- 备选方案：
  - 仅增强现有单行摘要字段，不引入阶段语义。缺点是定位“卡在哪一段”仍然困难。
  - 引入外部 tracing 系统。缺点是超出 MVP 约束且引入额外依赖。

### 决策 2: 复用并扩展现有 I/O 摘要能力，不重写日志栈
- 方案：在现有 `BuildRequestIoSummary` / `BuildResponseIoSummary` 基础上增加阶段、关联与耗时信息，并在请求处理链路补充阶段打点。
- 原因：改动范围可控，兼容现有测试与输出习惯。
- 备选方案：
  - 全量替换为新日志格式器。缺点是回归风险更高，且会增加迁移成本。

### 决策 3: 敏感字段脱敏与截断策略保持强约束
- 方案：继续对敏感头进行掩码，长文本进行截断，并明确截断标记。
- 原因：调试可观测性提升不能以泄露敏感信息为代价。
- 备选方案：
  - 在 debug 模式下输出完整原文。缺点是存在安全风险，不可接受。

### 决策 4: 对阻塞场景优先提供“可定位信号”
- 方案：在进入工具执行前记录阶段日志，在执行返回后记录完成日志；若仅见前者可直接判定阻塞点。
- 原因：当前最痛点是 `tools/call` 阻塞时缺少精确定位线索。
- 备选方案：
  - 直接实现执行超时。缺点是行为语义变化大，需额外设计回滚与兼容策略。

## 风险 / 权衡

- [日志字段增加导致噪声变多] -> 采用紧凑格式，保留摘要并限制单条长度。
- [阶段打点不一致导致误判] -> 在核心路径定义最小必选阶段并用测试校验。
- [增加格式断言后测试脆弱] -> 重点断言关键字段与语义，不对非关键文案做过度绑定。
- [高频请求下输出开销增加] -> 复用字符串摘要逻辑并限制附加计算（例如仅记录毫秒级耗时）。

## 迁移计划

1. 先更新增量规范，明确阶段日志与排障字段的可测试要求。
2. 按规范调整请求处理链路与日志摘要构建逻辑。
3. 补充/更新单元测试与输出结构测试，确保成功、失败、阻塞定位场景可覆盖。
4. 更新 README 诊断片段，提供新日志样例。

回滚策略：若新日志导致不可接受的噪声或兼容问题，可回滚到旧摘要格式；因不涉及协议变更，回滚风险较低。

## 待决问题

- “阶段日志”是否必须统一为固定枚举值，还是允许自由文本（建议固定枚举以利测试）。
- 对无 `id` 请求的关联键格式是否固定前缀（如 `local-<seq>`）以及是否需要跨进程稳定性（本次可仅要求进程内可追踪）。
