## 上下文

当前扩展仅在启动失败或服务启动成功时调用 `LogMessage`，不会将 MCP 请求体和返回体写入 WinDbg 会话输出。问题定位时，用户无法在同一调试会话中直接看到“请求输入/响应输出”的对应关系，必须借助外部客户端日志。

该变更需要在不改变 MCP 协议行为的前提下，补充可观测性输出，并保持现有 HTTP/JSON-RPC 处理链路稳定。

## 目标 / 非目标

**目标：**
- 在 WinDbg 可见输出中回显 MCP 请求与响应的关键内容，覆盖成功与失败路径。
- 保持现有 JSON-RPC 协议语义与 HTTP 状态码不变。
- 控制输出体积与敏感信息暴露风险，避免因大包体影响可读性。

**非目标：**
- 不引入新的远程日志系统或第三方依赖。
- 不变更 `windbg.eval` 的输入 Schema 或对外 HTTP 接口。
- 不实现复杂的日志持久化、检索或分级配置中心。

## 决策

1. 在扩展层增加统一的 MCP I/O 回显入口。
   - 在 `HandleRequest` 内记录请求摘要与响应摘要，确保每次请求都在同一链路产生可见回显。
   - 回显内容包含：HTTP 方法、路径、JSON-RPC 方法名（可解析时）、请求 id（可解析时）、响应状态码、响应体摘要。

2. 使用“摘要 + 截断”策略而非原样全量输出。
   - 默认输出可读摘要，超长请求体或响应体按固定上限截断并标记 `...(truncated)`。
   - 对常见敏感字段（如 Authorization）做掩码，避免将密钥直接打印到 WinDbg。

3. 回显写入沿用扩展现有输出机制，不引入新依赖。
   - 继续基于扩展内的日志输出能力（例如现有 `LogMessage` 路径）输出到 WinDbg 可见位置。
   - 保持实现在 C++/WinDbg 原生依赖范围内，符合工程约束。

4. 测试以“行为可验证”为主。
   - 为摘要格式化和截断/掩码规则增加单元测试。
   - 为请求处理链路增加规格映射，验证成功、协议错误和执行失败场景均有回显。

## 风险 / 权衡

- [风险] 回显过多导致 WinDbg 窗口噪声增加。  
  [缓解] 仅输出关键字段与摘要，限制长度并保持单行结构。

- [风险] 日志中泄露敏感信息。  
  [缓解] 对敏感头和可识别敏感字段进行掩码，避免完整原文输出。

- [风险] 输出逻辑与请求处理耦合后影响稳定性。  
  [缓解] 回显逻辑采用“失败不影响主流程”策略；格式化异常时退化为最小固定文本。

## 迁移计划

该变更为增量行为增强，无数据迁移。发布后默认启用回显能力；若出现噪声问题，可通过后续变更增加可配置开关。

## 开放问题

- WinDbg 可见输出的首选 API（现有 `OutputDebugStringA` 路径是否满足“窗口可见”要求，或需切换到调试引擎输出接口）需要在实现阶段确认并通过手工验证固化。
