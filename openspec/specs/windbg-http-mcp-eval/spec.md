# windbg-http-mcp-eval 规范

## 目的
待定 - 由归档变更 windbg-plugin-http-mcp-eval 创建。归档后请更新目的。
## 需求
### 需求:WinDbg 扩展 DLL 必须可加载并暴露核心能力
系统必须提供一个可被 WinDbg 加载的 C++ 扩展 DLL，并在初始化后可响应 MCP 相关请求处理逻辑。

#### 场景:扩展初始化成功
- **当** 用户在 WinDbg 中加载该扩展 DLL
- **那么** 扩展必须完成初始化并进入可服务状态

#### 场景:扩展卸载清理成功
- **当** WinDbg 触发扩展卸载流程
- **那么** 扩展必须释放其创建的资源并不遗留活动服务句柄

### 需求:MCP HTTP 端点必须提供最小可用 JSON-RPC 能力
系统必须在单一 HTTP 端点上处理 MCP JSON-RPC 请求，且至少支持 `initialize`、`tools/list`、`tools/call`。

#### 场景:初始化请求成功
- **当** 客户端向 MCP 端点发送 `initialize` JSON-RPC 请求
- **那么** 服务必须返回成功响应并声明 `windbg.eval` 工具可用

#### 场景:工具列表请求成功
- **当** 客户端发送 `tools/list` 请求
- **那么** 服务必须返回包含 `windbg.eval` 的工具定义

#### 场景:未知方法被拒绝
- **当** 客户端发送未实现的 JSON-RPC 方法
- **那么** 服务必须返回 JSON-RPC 错误响应

### 需求:MCP 请求与响应必须在 WinDbg 会话中可见回显
系统在处理 `/mcp` 请求时必须输出可读的请求/响应诊断信息到 WinDbg 可见输出，并且该输出必须不改变原有 JSON-RPC 处理结果。

#### 场景:请求成功时输出输入与输出摘要
- **当** 客户端向 `/mcp` 发送合法 `tools/call` 请求并得到成功响应
- **那么** 系统必须在 WinDbg 输出中包含该请求的关键输入摘要（方法、路径、JSON-RPC 方法或请求 id）
- **并且** 系统必须在 WinDbg 输出中包含对应响应摘要（HTTP 状态码与响应结果摘要）

#### 场景:请求失败时仍输出错误结果摘要
- **当** 客户端发送无效 JSON-RPC 请求并触发错误响应
- **那么** 系统必须在 WinDbg 输出中记录请求摘要和错误响应摘要
- **并且** 系统必须保持既有错误码与响应语义不变

#### 场景:超长或敏感内容被安全处理
- **当** 请求或响应包含超长文本，或请求头包含敏感字段
- **那么** 系统必须对回显内容执行长度截断并标记已截断
- **并且** 系统必须对敏感字段执行掩码，禁止直接输出原始敏感值

### 需求:windbg.eval 必须执行命令并返回文本输出
系统必须通过 `tools/call` 支持 `windbg.eval`，并将命令执行结果以文本形式返回。

#### 场景:命令执行成功
- **当** 客户端调用 `tools/call` 且工具名为 `windbg.eval`，并传入非空 `command`
- **那么** 服务必须调用 WinDbg 命令执行接口并返回命令输出文本

#### 场景:缺少命令参数
- **当** 客户端调用 `windbg.eval` 但未提供 `command` 或 `command` 为空
- **那么** 服务必须返回参数错误并且禁止执行调试命令

### 需求:实现必须符合工程与依赖约束
系统实现必须使用 CMake 管理构建，必须为 C++ WinDbg DLL，且禁止引入第三方依赖。

#### 场景:构建配置检查
- **当** 开发者查看构建脚本
- **那么** 脚本必须仅链接 Windows/WinDbg 相关系统库，并不包含第三方包管理配置

### 需求:测试规范必须纳入交付约束
系统必须为可单测逻辑提供单元测试，并保证每条规格场景至少有一个对应测试用例或可追踪映射。

#### 场景:场景到测试可追踪
- **当** 开发者实现本变更任务
- **那么** 每条规格场景必须在测试代码或测试映射文档中具有可追踪对应关系

#### 场景:测试执行门禁
- **当** 运行 CTest
- **那么** 单元测试必须全部通过后才可视为本变更完成

### 需求:WinDbg 扩展导出契约必须可验证
系统必须为扩展 DLL 定义并验证稳定导出符号集合，至少包括 `DebugExtensionInitialize`、`DebugExtensionUninitialize`、`DebugExtensionCanUnload`，并与当前实现公开入口保持一致。

#### 场景:导出符号检查通过
- **当** 开发者完成扩展 DLL 构建并执行导出检查
- **那么** 检查结果必须包含所有必需符号并返回成功状态

#### 场景:缺失导出被阻断
- **当** 任一必需导出符号缺失或名称不匹配
- **那么** 验证流程必须失败并阻止该产物进入交付

### 需求:加载说明必须提供可执行诊断路径
系统必须在用户文档中提供可直接执行的 `.load` 示例与最小故障诊断步骤，覆盖路径写法和常见加载失败错误。

#### 场景:路径写法可直接复用
- **当** 用户按照文档使用绝对路径加载扩展
- **那么** 文档必须给出不会导致路径分隔符歧义的命令写法示例

#### 场景:加载失败有诊断指引
- **当** `.load` 失败并返回错误码
- **那么** 文档必须提供对应的最小排查步骤（路径存在性、依赖检查或导出检查）
